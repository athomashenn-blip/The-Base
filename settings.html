<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>The Base - Settings</title>
    <style>
      :root {
        --text: #f2f3f8;
        --muted: #b8b3c9;
        --line: #3f4452;
        --line-2: #4a5060;
        --btn-line: #545b6d;
        --btn-active: #7c889f;
        --theme-bg-a: #101116;
        --theme-bg-b: #171922;
        --theme-bg-c: #111217;
        --theme-glow-a: #6a738420;
        --theme-glow-b: #8d97aa1a;
        --theme-header-a: #282434;
        --theme-header-b: #201d2c;
        --theme-main-a: #24222e;
        --theme-main-b: #1f1d29;
        --theme-card-a: #2a2736;
        --theme-card-b: #22202d;
        --logo-hue: 0deg;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: "Avenir Next", "Segoe UI", sans-serif;
        color: var(--text);
        background:
          radial-gradient(circle at 12% 8%, var(--theme-glow-a) 0%, transparent 42%),
          radial-gradient(circle at 90% 12%, var(--theme-glow-b) 0%, transparent 34%),
          linear-gradient(160deg, var(--theme-bg-a), var(--theme-bg-b) 62%, var(--theme-bg-c));
      }
      .shell { max-width: none; width: 100%; margin: 0; padding: 0.45rem 0.55rem; }
      .header {
        border: 1px solid var(--line);
        border-radius: 24px;
        padding: 0.8rem 1.1rem;
        background: linear-gradient(180deg, var(--theme-header-a), var(--theme-header-b));
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        box-shadow: 0 10px 25px #00000040;
      }
      .brand { display: flex; align-items: center; gap: 0.75rem; }
      .brand-logo {
        width: 64px;
        height: 64px;
        object-fit: cover;
        border-radius: 50%;
        border: 2px solid var(--line);
        box-shadow: 0 6px 16px #00000055;
        display: block;
        filter: hue-rotate(var(--logo-hue, 0deg)) saturate(1.08);
      }
      .brand-dot {
        width: 42px;
        height: 42px;
        border-radius: 999px;
        background: linear-gradient(150deg, #ff2d72, #ff5b5b);
        display: grid;
        place-items: center;
        font-weight: 800;
        font-size: 1.3rem;
      }
      .brand-wordmark { font-weight: 700; letter-spacing: 0.08em; }
      .brand p { margin: 0.18rem 0 0; color: var(--muted); font-size: 0.8rem; }
      .header-links { display: flex; gap: 1.5rem; color: #99a9d7; font-weight: 500; }
      .header-link-btn {
        border: 0;
        background: transparent;
        padding: 0;
        color: #99a9d7;
        cursor: pointer;
        text-decoration: none;
      }
      .header-link-btn:hover { color: #dce7ff; }
      .header-link-group {
        position: relative;
        display: inline-flex;
        align-items: center;
        padding-bottom: 0.35rem;
        margin-bottom: -0.35rem;
      }
      .header-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        min-width: 170px;
        border: 1px solid var(--line);
        border-radius: 10px;
        background: #1d222d;
        box-shadow: 0 10px 24px #00000055;
        padding: 0.25rem;
        display: none;
        z-index: 50;
      }
      .header-link-group:hover .header-dropdown,
      .header-link-group:focus-within .header-dropdown { display: grid; }
      .header-dropdown a {
        color: #dbe5ff;
        text-decoration: none;
        padding: 0.42rem 0.55rem;
        border-radius: 8px;
        font-size: 0.86rem;
      }
      .header-dropdown a:hover { background: #2a3040; }
      .header-links .active { color: #fff; border-bottom: 2px solid var(--btn-active); padding-bottom: 0.2rem; }
      .header-actions { display: flex; gap: 0.4rem; align-items: center; }

      .layout {
        margin-top: 0.8rem;
        display: grid;
        grid-template-columns: 1fr;
        gap: 0.8rem;
      }
      .nav {
        border: 1px solid var(--line);
        border-radius: 22px;
        padding: 1rem 0.8rem;
        background: linear-gradient(180deg, var(--theme-main-a), var(--theme-main-b) 74%, color-mix(in srgb, var(--theme-main-b) 80%, #000 20%));
        display: grid;
        gap: 0.5rem;
        align-content: start;
      }
      .nav button {
        width: 100%;
        text-align: left;
        border: 1px solid var(--btn-line);
        background: linear-gradient(180deg, color-mix(in srgb, var(--theme-card-a) 85%, #000 15%), color-mix(in srgb, var(--theme-card-b) 85%, #000 15%));
        border-radius: 12px;
        padding: 0.65rem;
        color: var(--text);
        cursor: pointer;
      }
      .nav button.active { border-color: var(--btn-active); background: linear-gradient(180deg, color-mix(in srgb, var(--btn-active) 42%, #1d1a2a 58%), color-mix(in srgb, var(--btn-line) 55%, #181522 45%)); }
      .subnav {
        display: grid;
        gap: 0.35rem;
        margin: -0.1rem 0 0.3rem;
        padding-left: 0.4rem;
        max-height: 220px;
        opacity: 1;
        overflow: hidden;
        transition: max-height 220ms ease, opacity 180ms ease, margin 200ms ease;
      }
      .subnav.hidden { max-height: 0; opacity: 0; margin: 0; }
      .subnav button { font-size: 0.84rem; padding: 0.45rem 0.55rem; border-style: dashed; }
      .nav-main { display: flex; align-items: center; justify-content: space-between; }
      .nav-arrow { display: inline-block; font-size: 0.7rem; color: #9fb1de; transition: transform 220ms ease; }

      .main {
        border: 1px solid var(--line);
        border-radius: 22px;
        background: linear-gradient(180deg, var(--theme-main-a), var(--theme-main-b) 78%);
        padding: 1rem;
      }
      .card {
        border: 1px solid var(--line-2);
        border-radius: 14px;
        padding: 0.8rem;
        background: linear-gradient(170deg, var(--theme-card-a), var(--theme-card-b));
      }
      .settings-layout {
        display: grid;
        grid-template-columns: 1fr;
        gap: 0.75rem;
      }
      .settings-tabs {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 0.35rem;
      }
      .settings-tabs button {
        width: 100%;
        text-align: left;
        border: 1px solid var(--btn-line);
        border-radius: 10px;
        background: #1a1c25;
        color: var(--text);
        padding: 0.5rem 0.6rem;
        cursor: pointer;
      }
      .settings-tabs button.active {
        border-color: var(--btn-active);
        background: color-mix(in srgb, var(--btn-active) 18%, #1a1c25 82%);
      }
      .row {
        display: grid;
        grid-template-columns: repeat(5, minmax(0, 1fr));
        gap: 0.45rem;
      }
      .row-3 {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 0.45rem;
      }
      .table-wrap {
        overflow: auto;
        border: 1px solid var(--line-2);
        border-radius: 10px;
      }
      table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
      th, td { border: 1px solid var(--line); padding: 0.35rem 0.4rem; vertical-align: top; }
      th { position: sticky; top: 0; background: #1f2534; }
      input, select, textarea {
        width: 100%;
        background: #171924;
        border: 1px solid var(--line-2);
        color: var(--text);
        border-radius: 8px;
        padding: 0.42rem;
      }
      textarea { min-height: 88px; resize: vertical; }
      .actions { display: flex; gap: 0.45rem; flex-wrap: wrap; }
      .btn {
        border: 1px solid var(--btn-line);
        border-radius: 8px;
        background: #212533;
        color: var(--text);
        padding: 0.45rem 0.65rem;
        cursor: pointer;
      }
      .btn.primary {
        border-color: var(--btn-active);
        background: color-mix(in srgb, var(--btn-active) 20%, #1d2330 80%);
      }
      .err { color: #ff9dad; font-size: 0.82rem; min-height: 1.1em; }
      .pill {
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
        border: 1px solid var(--line-2);
        border-radius: 999px;
        padding: 0.12rem 0.45rem;
        font-size: 0.78rem;
      }
      .muted { color: var(--muted); font-size: 0.9rem; }
      body[data-dept="Video"] {
        --logo-hue: -150deg;
        --line: #3e784f; --line-2: #4d8f61; --btn-line: #579b67; --btn-active: #70c984;
        --theme-bg-a: #0f1612; --theme-bg-b: #131f17; --theme-bg-c: #101511;
        --theme-glow-a: #4ec06b2f; --theme-glow-b: #8ff0a13d; --theme-header-a: #213326; --theme-header-b: #1b281f;
        --theme-main-a: #1e2a22; --theme-main-b: #18231c; --theme-card-a: #233226; --theme-card-b: #1a261d;
      }
      body[data-dept="Sound"] {
        --logo-hue: -35deg;
        --line: #3e5e97; --line-2: #4a6ca9; --btn-line: #5479bb; --btn-active: #74a9ff;
        --theme-bg-a: #101420; --theme-bg-b: #141b2a; --theme-bg-c: #0f131e;
        --theme-glow-a: #4e7cd03a; --theme-glow-b: #71a2ff33; --theme-header-a: #212944; --theme-header-b: #1a2137;
        --theme-main-a: #1e2538; --theme-main-b: #171e2d; --theme-card-a: #252d46; --theme-card-b: #1b2235;
      }
      body[data-dept="Lighting"] {
        --logo-hue: 90deg;
        --line: #8a3e44; --line-2: #9c474d; --btn-line: #b2555d; --btn-active: #ff7b85;
        --theme-bg-a: #1b1214; --theme-bg-b: #26181b; --theme-bg-c: #1a1113;
        --theme-glow-a: #d14e5d30; --theme-glow-b: #ff7e7e2e; --theme-header-a: #3a2326; --theme-header-b: #2b1b1d;
        --theme-main-a: #332225; --theme-main-b: #271b1d; --theme-card-a: #3a2528; --theme-card-b: #2b1d1f;
      }
      body[data-dept="Power"] {
        --logo-hue: 0deg;
        --line: #634699; --line-2: #7454ad; --btn-line: #7f5ec0; --btn-active: #aa84ff;
        --theme-bg-a: #14121f; --theme-bg-b: #1d1a2b; --theme-bg-c: #12101b;
        --theme-glow-a: #7e5acf34; --theme-glow-b: #ab85ff2e; --theme-header-a: #2f2744; --theme-header-b: #241f34;
        --theme-main-a: #2a243a; --theme-main-b: #201c2d; --theme-card-a: #322a46; --theme-card-b: #262038;
      }
      body[data-dept="Rigging"] {
        --logo-hue: 120deg;
        --line: #a4652c; --line-2: #be7736; --btn-line: #cf833e; --btn-active: #ffab4f;
        --theme-bg-a: #1c1510; --theme-bg-b: #261c13; --theme-bg-c: #1a130d;
        --theme-glow-a: #d67a2e2f; --theme-glow-b: #ffb35a2a; --theme-header-a: #3b2517; --theme-header-b: #2c1b11;
        --theme-main-a: #342518; --theme-main-b: #261c13; --theme-card-a: #3f2a19; --theme-card-b: #2f2013;
      }
      body[data-dept="Venue"] {
        --logo-hue: -100deg;
        --line: #3f8a86; --line-2: #49a29d; --btn-line: #54b5b0; --btn-active: #6ad8d1;
        --theme-bg-a: #101a19; --theme-bg-b: #132423; --theme-bg-c: #0f1716;
        --theme-glow-a: #45b6ac2e; --theme-glow-b: #7de9df2a; --theme-header-a: #1f3230; --theme-header-b: #182826;
        --theme-main-a: #1d2d2b; --theme-main-b: #172422; --theme-card-a: #223634; --theme-card-b: #1b2a28;
      }
      /* Keep UI neutral grey; preserve department accents for highlights */
      body[data-dept] {
        --theme-bg-a: #101116;
        --theme-bg-b: #171922;
        --theme-bg-c: #111217;
        --theme-glow-a: #6a738420;
        --theme-glow-b: #8d97aa1a;
        --theme-header-a: #282434;
        --theme-header-b: #201d2c;
        --theme-main-a: #24222e;
        --theme-main-b: #1f1d29;
        --theme-card-a: #2a2736;
        --theme-card-b: #22202d;
      }
      @media (max-width: 1100px) {
        .layout { grid-template-columns: 1fr; }
        .nav { grid-template-columns: repeat(6, minmax(0, 1fr)); }
        .settings-layout { grid-template-columns: 1fr; }
      }
      @media (max-width: 820px) {
        .nav { grid-template-columns: 1fr; }
        .header { flex-direction: column; align-items: flex-start; }
      }
    </style>
  </head>
  <body>
    <div class="shell">
      <header class="header">
        <div class="brand">
          <img id="brandLogo" class="brand-logo" src="assets/base-logo.png" alt="BASE Logo" />
          <div class="brand-dot" id="brandFallback" style="display:none;">B</div>
          <div>
            <div class="brand-wordmark">THE BASE</div>
            <p>Technical planning dashboard for Video, Lighting, Audio, Staging & Rigging.</p>
          </div>
        </div>
        <div class="header-links">
          <a class="header-link-btn" href="projects.html">Projects</a>
          <div class="header-link-group">
            <a class="header-link-btn" href="index.html">Engineering</a>
            <div class="header-dropdown" aria-label="Engineering Departments">
              <a href="index.html?dept=Video">Video</a>
              <a href="index.html?dept=Lighting">Lighting</a>
              <a href="index.html?dept=Sound">Sound</a>
              <a href="index.html?dept=Rigging">Rigging</a>
              <a href="index.html?dept=Power">Power</a>
              <a href="index.html?dept=Venue">Venue</a>
            </div>
          </div>
          <a class="header-link-btn" href="reports.html">Reports</a>
          <a class="header-link-btn active" href="settings.html">Settings</a>
        </div>
        <div class="header-actions"></div>
      </header>

      <section class="layout">
        <main class="main">
          <div class="settings-layout">
            <section class="card">
              <div style="display:flex;justify-content:space-between;gap:0.5rem;align-items:flex-end;flex-wrap:wrap;">
                <div>
                  <h2 style="margin:0;">Settings</h2>
                  <div class="muted">Single source of truth for engineering modules.</div>
                </div>
                <div class="actions">
                  <button class="btn" id="settingsExportBtn">Export JSON</button>
                  <label class="btn" for="settingsImportFile" style="display:inline-flex;align-items:center;">Import JSON</label>
                  <input id="settingsImportFile" type="file" accept="application/json" style="display:none;" />
                </div>
              </div>
              <div class="settings-tabs" id="settingsTabs" style="margin-top:0.65rem;"></div>
              <div style="display:flex;justify-content:space-between;gap:0.5rem;align-items:flex-end;flex-wrap:wrap;">
                <div>
                  <h2 id="settingsSectionTitle" style="margin:0;">Department</h2>
                  <div class="muted" id="settingsSectionSubtitle">Manage equipment and rules.</div>
                </div>
                <div class="actions">
                  <input id="settingsSearch" placeholder="Search manufacturer, name, notes..." style="min-width:260px;" />
                  <label class="pill"><input type="checkbox" id="settingsShowDisabled" /> Show disabled</label>
                </div>
              </div>
              <div class="table-wrap" style="margin-top:0.65rem;">
                <table>
                  <thead>
                    <tr>
                      <th>Manufacturer</th>
                      <th>Name</th>
                      <th>Weight (kg)</th>
                      <th>Power (W / A)</th>
                      <th>Notes</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="settingsEquipmentTable"></tbody>
                </table>
              </div>
              <div class="card" style="margin-top:0.75rem;">
                <h3 id="equipmentFormTitle" style="margin-top:0;">Add Equipment</h3>
                <div class="row">
                  <div><label>Manufacturer</label><input id="eqManufacturer" /></div>
                  <div><label>Name</label><input id="eqName" /></div>
                  <div><label>Weight (kg)</label><input id="eqWeight" type="number" min="0" step="0.01" /></div>
                  <div><label>Power Watts</label><input id="eqPowerW" type="number" min="0" step="0.1" /></div>
                  <div><label>Power Amps</label><input id="eqPowerA" type="number" min="0" step="0.01" /></div>
                </div>
                <div style="margin-top:0.45rem;">
                  <label>Notes</label>
                  <textarea id="eqNotes"></textarea>
                </div>
                <div class="err" id="equipmentFormError"></div>
                <div class="actions">
                  <button class="btn primary" id="equipmentSaveBtn">Save</button>
                  <button class="btn" id="equipmentCancelBtn">Cancel</button>
                </div>
              </div>
              <div class="card" style="margin-top:0.75rem;">
                <h3 style="margin-top:0;">Rules (JSON)</h3>
                <div class="muted">Editable assumptions and calculation rules per department.</div>
                <textarea id="deptRulesJson" style="margin-top:0.45rem;min-height:120px;"></textarea>
                <div class="err" id="deptRulesError"></div>
                <div class="actions">
                  <button class="btn primary" id="deptRulesSaveBtn">Save Rules</button>
                </div>
              </div>
              <div class="card" style="margin-top:0.75rem;">
                <h3 style="margin-top:0;">Global Defaults</h3>
                <div class="row-3">
                  <div><label>Distance Unit</label><input id="globalDistanceUnit" /></div>
                  <div><label>Weight Unit</label><input id="globalWeightUnit" /></div>
                  <div><label>Power Unit</label><input id="globalPowerUnit" /></div>
                </div>
                <div class="row-3" style="margin-top:0.45rem;">
                  <div><label>Current Unit</label><input id="globalCurrentUnit" /></div>
                  <div><label>Rigging Safety Factor</label><input id="globalRigSafety" type="number" min="0.1" step="0.01" /></div>
                  <div><label>Electrical Safety Factor</label><input id="globalElecSafety" type="number" min="0.1" step="0.01" /></div>
                </div>
                <div class="actions" style="margin-top:0.55rem;">
                  <button class="btn primary" id="globalSaveBtn">Save Global</button>
                </div>
              </div>
            </section>
          </div>
        </main>
      </section>
    </div>

    <script src="data/settings-store.js"></script>
    <script>
      const logo = document.getElementById("brandLogo");
      const fallback = document.getElementById("brandFallback");
      if (logo && fallback) {
        logo.addEventListener("error", () => {
          logo.style.display = "none";
          fallback.style.display = "grid";
        });
      }
      function applyDeptTheme(dept) {
        const mapped = dept || "Video";
        document.body.setAttribute("data-dept", mapped);
        localStorage.setItem("thebase.activeDept", mapped);
      }
      const storedDept = localStorage.getItem("thebase.activeDept") || "Video";
      applyDeptTheme(storedDept);

      const SETTINGS_TABS = ["Global", "Video", "Lighting", "Audio", "Rigging", "Power", "Venue"];
      const seedDefaults = {
        departments: {
          Video: { equipment: [] },
          Lighting: { equipment: [] },
          Audio: { equipment: [] },
          Rigging: { equipment: [{ manufacturer: "Generic", name: "PA", weight_kg: 150, power_use: { watts: null, amps: null }, notes: "Additional", enabled: true }, { manufacturer: "Generic", name: "Projector", weight_kg: 25, power_use: { watts: null, amps: null }, notes: "Additional", enabled: true }] },
          Power: { equipment: [] },
          Venue: { equipment: [] }
        }
      };

      let settingsState = TheBaseSettings.loadSettings(seedDefaults);
      let activeSettingsTab = "Global";
      let editingEquipmentId = "";

      const ui = {
        tabs: document.getElementById("settingsTabs"),
        title: document.getElementById("settingsSectionTitle"),
        subtitle: document.getElementById("settingsSectionSubtitle"),
        table: document.getElementById("settingsEquipmentTable"),
        search: document.getElementById("settingsSearch"),
        showDisabled: document.getElementById("settingsShowDisabled"),
        formTitle: document.getElementById("equipmentFormTitle"),
        manufacturer: document.getElementById("eqManufacturer"),
        name: document.getElementById("eqName"),
        weight: document.getElementById("eqWeight"),
        powerW: document.getElementById("eqPowerW"),
        powerA: document.getElementById("eqPowerA"),
        notes: document.getElementById("eqNotes"),
        formError: document.getElementById("equipmentFormError"),
        rulesJson: document.getElementById("deptRulesJson"),
        rulesError: document.getElementById("deptRulesError"),
        globalDistance: document.getElementById("globalDistanceUnit"),
        globalWeight: document.getElementById("globalWeightUnit"),
        globalPower: document.getElementById("globalPowerUnit"),
        globalCurrent: document.getElementById("globalCurrentUnit"),
        globalRigSafety: document.getElementById("globalRigSafety"),
        globalElecSafety: document.getElementById("globalElecSafety")
      };

      function saveSettingsState() {
        settingsState = TheBaseSettings.saveSettings(settingsState);
      }

      function getActiveEquipment() {
        if (activeSettingsTab === "Global") return [];
        return settingsState.departments[activeSettingsTab]?.equipment || [];
      }

      function resetForm() {
        editingEquipmentId = "";
        ui.formTitle.textContent = "Add Equipment";
        ui.manufacturer.value = "";
        ui.name.value = "";
        ui.weight.value = "";
        ui.powerW.value = "";
        ui.powerA.value = "";
        ui.notes.value = "";
        ui.formError.textContent = "";
      }

      function fillFormForEdit(item) {
        editingEquipmentId = item.id;
        ui.formTitle.textContent = "Edit Equipment";
        ui.manufacturer.value = item.manufacturer || "";
        ui.name.value = item.name || "";
        ui.weight.value = item.weight_kg ?? "";
        ui.powerW.value = item.power_use?.watts ?? "";
        ui.powerA.value = item.power_use?.amps ?? "";
        ui.notes.value = item.notes || "";
        ui.formError.textContent = "";
      }

      function renderTabs() {
        ui.tabs.innerHTML = SETTINGS_TABS.map((tab) => `<button data-settings-tab="${tab}" class="${tab === activeSettingsTab ? "active" : ""}">${tab}</button>`).join("");
        ui.tabs.querySelectorAll("[data-settings-tab]").forEach((btn) => {
          btn.addEventListener("click", () => {
            activeSettingsTab = btn.dataset.settingsTab || "Global";
            editingEquipmentId = "";
            renderSettingsView();
          });
        });
      }

      function renderEquipmentTable() {
        const rows = getActiveEquipment();
        const q = String(ui.search.value || "").trim().toLowerCase();
        const showDisabled = ui.showDisabled.checked;
        const filtered = rows.filter((r) => {
          if (!showDisabled && r.enabled === false) return false;
          if (!q) return true;
          return `${r.manufacturer} ${r.name} ${r.notes}`.toLowerCase().includes(q);
        });
        ui.table.innerHTML = filtered.map((item) => `
          <tr>
            <td>${item.manufacturer || "-"}</td>
            <td>${item.name || "-"}</td>
            <td>${item.weight_kg ?? "-"}</td>
            <td>${item.power_use?.watts ?? "-"}W / ${item.power_use?.amps ?? "-"}A</td>
            <td>${item.notes || "-"}</td>
            <td>${item.enabled === false ? "<span class='pill'>Disabled</span>" : "<span class='pill'>Enabled</span>"}</td>
            <td>
              <div class="actions">
                <button class="btn" data-eq-edit="${item.id}">Edit</button>
                <button class="btn" data-eq-toggle="${item.id}">${item.enabled === false ? "Enable" : "Disable"}</button>
                <button class="btn" data-eq-delete="${item.id}">Delete</button>
              </div>
            </td>
          </tr>
        `).join("") || `<tr><td colspan="7" class="muted">No equipment for this section.</td></tr>`;
        ui.table.querySelectorAll("[data-eq-edit]").forEach((b) => {
          b.addEventListener("click", () => {
            const id = b.dataset.eqEdit;
            const item = getActiveEquipment().find((x) => x.id === id);
            if (item) fillFormForEdit(item);
          });
        });
        ui.table.querySelectorAll("[data-eq-toggle]").forEach((b) => {
          b.addEventListener("click", () => {
            const id = b.dataset.eqToggle;
            const item = getActiveEquipment().find((x) => x.id === id);
            if (!item || activeSettingsTab === "Global") return;
            const updated = { ...item, enabled: item.enabled === false };
            settingsState = TheBaseSettings.upsertEquipment(settingsState, activeSettingsTab, updated);
            saveSettingsState();
            renderSettingsView();
          });
        });
        ui.table.querySelectorAll("[data-eq-delete]").forEach((b) => {
          b.addEventListener("click", () => {
            const id = b.dataset.eqDelete;
            if (!id || activeSettingsTab === "Global") return;
            settingsState = TheBaseSettings.removeEquipment(settingsState, activeSettingsTab, id, true);
            saveSettingsState();
            renderSettingsView();
          });
        });
      }

      function renderRules() {
        const isGlobal = activeSettingsTab === "Global";
        ui.rulesJson.disabled = isGlobal;
        document.getElementById("deptRulesSaveBtn").disabled = isGlobal;
        if (isGlobal) {
          ui.rulesJson.value = "{}";
          ui.rulesError.textContent = "";
          return;
        }
        ui.rulesJson.value = JSON.stringify(settingsState.departments[activeSettingsTab]?.rules || {}, null, 2);
        ui.rulesError.textContent = "";
      }

      function renderGlobals() {
        const g = settingsState.global || {};
        ui.globalDistance.value = g.units?.distance || "m";
        ui.globalWeight.value = g.units?.weight || "kg";
        ui.globalPower.value = g.units?.power || "W";
        ui.globalCurrent.value = g.units?.current || "A";
        ui.globalRigSafety.value = g.safety_factors?.rigging ?? 1.2;
        ui.globalElecSafety.value = g.safety_factors?.electrical ?? 0.8;
      }

      function renderSettingsView() {
        renderTabs();
        const isGlobal = activeSettingsTab === "Global";
        const themeDeptMap = {
          Global: "Power",
          Video: "Video",
          Lighting: "Lighting",
          Audio: "Sound",
          Rigging: "Rigging",
          Power: "Power",
          Venue: "Venue"
        };
        applyDeptTheme(themeDeptMap[activeSettingsTab] || "Power");
        ui.title.textContent = isGlobal ? "Global Settings" : `${activeSettingsTab} Settings`;
        ui.subtitle.textContent = isGlobal
          ? "Global defaults for units, safety and exports."
          : `Manage ${activeSettingsTab} equipment and rules.`;
        ui.search.disabled = isGlobal;
        ui.showDisabled.disabled = isGlobal;
        ["manufacturer", "name", "weight", "powerW", "powerA", "notes"].forEach((k) => { ui[k].disabled = isGlobal; });
        document.getElementById("equipmentSaveBtn").disabled = isGlobal;
        document.getElementById("equipmentCancelBtn").disabled = isGlobal;
        renderEquipmentTable();
        renderRules();
        renderGlobals();
        if (isGlobal) resetForm();
      }

      function validateEquipmentInput() {
        const manufacturer = String(ui.manufacturer.value || "").trim();
        const name = String(ui.name.value || "").trim();
        const weight = ui.weight.value === "" ? null : Number(ui.weight.value);
        const watts = ui.powerW.value === "" ? null : Number(ui.powerW.value);
        const amps = ui.powerA.value === "" ? null : Number(ui.powerA.value);
        if (!manufacturer) return { ok: false, message: "Manufacturer is required." };
        if (!name) return { ok: false, message: "Name is required." };
        if (weight !== null && (!Number.isFinite(weight) || weight < 0)) return { ok: false, message: "Weight must be >= 0." };
        if (watts !== null && (!Number.isFinite(watts) || watts < 0)) return { ok: false, message: "Power watts must be >= 0." };
        if (amps !== null && (!Number.isFinite(amps) || amps < 0)) return { ok: false, message: "Power amps must be >= 0." };
        return { ok: true, value: { manufacturer, name, weight, watts, amps, notes: String(ui.notes.value || "").trim() } };
      }

      document.getElementById("equipmentSaveBtn")?.addEventListener("click", () => {
        if (activeSettingsTab === "Global") return;
        const v = validateEquipmentInput();
        if (!v.ok) {
          ui.formError.textContent = v.message;
          return;
        }
        const existing = getActiveEquipment().find((x) => x.id === editingEquipmentId);
        const next = {
          id: existing?.id || TheBaseSettings.uid(`eq_${activeSettingsTab.toLowerCase()}`),
          manufacturer: v.value.manufacturer,
          name: v.value.name,
          weight_kg: v.value.weight,
          power_use: { watts: v.value.watts, amps: v.value.amps },
          notes: v.value.notes,
          enabled: existing?.enabled !== false,
          meta: existing?.meta || {}
        };
        settingsState = TheBaseSettings.upsertEquipment(settingsState, activeSettingsTab, next);
        saveSettingsState();
        resetForm();
        renderSettingsView();
      });

      document.getElementById("equipmentCancelBtn")?.addEventListener("click", () => {
        resetForm();
      });

      document.getElementById("deptRulesSaveBtn")?.addEventListener("click", () => {
        if (activeSettingsTab === "Global") return;
        try {
          const parsed = JSON.parse(String(ui.rulesJson.value || "{}"));
          settingsState.departments[activeSettingsTab].rules = parsed && typeof parsed === "object" ? parsed : {};
          saveSettingsState();
          ui.rulesError.textContent = "";
        } catch (err) {
          ui.rulesError.textContent = `Invalid JSON: ${err.message}`;
        }
      });

      document.getElementById("globalSaveBtn")?.addEventListener("click", () => {
        settingsState.global.units.distance = String(ui.globalDistance.value || "m").trim() || "m";
        settingsState.global.units.weight = String(ui.globalWeight.value || "kg").trim() || "kg";
        settingsState.global.units.power = String(ui.globalPower.value || "W").trim() || "W";
        settingsState.global.units.current = String(ui.globalCurrent.value || "A").trim() || "A";
        settingsState.global.safety_factors.rigging = Math.max(0.1, Number(ui.globalRigSafety.value || 1.2));
        settingsState.global.safety_factors.electrical = Math.max(0.1, Number(ui.globalElecSafety.value || 0.8));
        saveSettingsState();
        renderSettingsView();
      });

      ui.search?.addEventListener("input", renderEquipmentTable);
      ui.showDisabled?.addEventListener("change", renderEquipmentTable);

      document.getElementById("settingsExportBtn")?.addEventListener("click", () => {
        const json = TheBaseSettings.exportSettingsJson(settingsState);
        const blob = new Blob([json], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "the-base-settings.json";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      });
      document.getElementById("settingsImportFile")?.addEventListener("change", (ev) => {
        const target = ev.target;
        if (!(target instanceof HTMLInputElement) || !target.files?.length) return;
        const file = target.files[0];
        file.text().then((text) => {
          try {
            settingsState = TheBaseSettings.importSettingsJson(text, seedDefaults);
            saveSettingsState();
            resetForm();
            renderSettingsView();
          } catch (err) {
            alert(`Import failed: ${err.message}`);
          } finally {
            target.value = "";
          }
        });
      });

      renderSettingsView();
    </script>
  </body>
</html>
