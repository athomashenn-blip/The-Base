<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>The Base - Projects</title>
    <style>
      :root {
        --text: #f2f3f8;
        --muted: #b8b3c9;
        --line: #3f4452;
        --line-2: #4a5060;
        --btn-line: #545b6d;
        --btn-active: #7c889f;
        --theme-bg-a: #101116;
        --theme-bg-b: #171922;
        --theme-bg-c: #111217;
        --theme-glow-a: #6a738420;
        --theme-glow-b: #8d97aa1a;
        --theme-header-a: #2b3039;
        --theme-header-b: #232831;
        --theme-main-a: #252932;
        --theme-main-b: #20242c;
        --theme-card-a: #303640;
        --theme-card-b: #282e38;
        --theme-input: #1b1923;
        --theme-btn-a: #343946;
        --theme-btn-b: #2a2f3a;
        --logo-hue: 0deg;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: "Avenir Next", "Segoe UI", sans-serif;
        color: var(--text);
        background:
          radial-gradient(circle at 12% 8%, var(--theme-glow-a) 0%, transparent 42%),
          radial-gradient(circle at 90% 12%, var(--theme-glow-b) 0%, transparent 34%),
          linear-gradient(160deg, var(--theme-bg-a), var(--theme-bg-b) 62%, var(--theme-bg-c));
      }
      .shell { max-width: none; width: 100%; margin: 0; padding: 0.45rem 0.55rem; }
      .header {
        border: 1px solid var(--line);
        border-radius: 24px;
        padding: 0.8rem 1.1rem;
        background: linear-gradient(180deg, var(--theme-header-a), var(--theme-header-b));
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        box-shadow: 0 10px 25px #00000040;
        margin-bottom: 12px;
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }
      .brand-logo {
        width: 64px;
        height: 64px;
        object-fit: cover;
        border-radius: 50%;
        border: 2px solid var(--line);
        box-shadow: 0 6px 16px #00000055;
        display: block;
        filter: hue-rotate(var(--logo-hue, 0deg)) saturate(1.08);
      }
      .brand-dot {
        width: 42px;
        height: 42px;
        border-radius: 999px;
        background: linear-gradient(150deg, #ff2d72, #ff5b5b);
        display: grid;
        place-items: center;
        font-weight: 800;
        font-size: 1.3rem;
      }
      .brand-wordmark { font-weight: 700; letter-spacing: 0.08em; }
      .brand p { margin: 0.18rem 0 0; color: var(--muted); font-size: 0.8rem; }
      .header-links {
        display: flex;
        gap: 1.5rem;
        color: #99a9d7;
        font-weight: 500;
      }
      .header-actions {
        display: flex;
        gap: 0.4rem;
        align-items: center;
      }
      .header-link-btn {
        border: 0;
        background: transparent;
        padding: 0;
        color: #99a9d7;
        cursor: pointer;
        text-decoration: none;
      }
      .header-link-btn:hover { color: #dce7ff; }
      .header-link-group {
        position: relative;
        display: inline-flex;
        align-items: center;
        padding-bottom: 0.35rem;
        margin-bottom: -0.35rem;
      }
      .header-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        min-width: 170px;
        border: 1px solid var(--line);
        border-radius: 10px;
        background: #1d222d;
        box-shadow: 0 10px 24px #00000055;
        padding: 0.25rem;
        display: none;
        z-index: 50;
      }
      .header-link-group:hover .header-dropdown,
      .header-link-group:focus-within .header-dropdown { display: grid; }
      .header-dropdown a {
        color: #dbe5ff;
        text-decoration: none;
        padding: 0.42rem 0.55rem;
        border-radius: 8px;
        font-size: 0.86rem;
      }
      .header-dropdown a:hover { background: #2a3040; }
      .header-links .active {
        color: #fff;
        border-bottom: 2px solid var(--btn-active);
        padding-bottom: 0.2rem;
      }
      .layout {
        margin-top: 0.8rem;
        display: grid;
        grid-template-columns: minmax(0, 1fr);
        gap: 0.8rem;
        align-items: start;
      }
      .main {
        border: 1px solid var(--line);
        border-radius: 22px;
        background: linear-gradient(180deg, var(--theme-main-a), var(--theme-main-b) 78%);
        padding: 1rem;
        min-height: calc(100vh - 182px);
      }
      .properties-panel {
        border: 1px solid var(--line);
        border-radius: 22px;
        background: linear-gradient(180deg, var(--theme-main-a), var(--theme-main-b) 78%);
        padding: 0.7rem;
        position: sticky;
        top: 0.8rem;
        max-height: calc(100vh - 112px);
        display: grid;
        grid-template-rows: auto auto 1fr;
        gap: 0.55rem;
      }
      .property-tabs {
        display: grid;
        grid-template-columns: repeat(6, minmax(0, 1fr));
        gap: 0.35rem;
      }
      .property-tabs button {
        padding: 0.35rem 0.25rem;
        font-size: 0.72rem;
      }
      .property-panel-body {
        overflow: auto;
        border: 1px solid var(--line-2);
        border-radius: 10px;
        padding: 0.5rem;
        background: var(--theme-input);
      }
      .property-row {
        display: grid;
        grid-template-columns: 120px minmax(0, 1fr);
        gap: 0.45rem;
        align-items: center;
        padding: 0.28rem 0;
        border-bottom: 1px solid color-mix(in srgb, var(--line-2), transparent 50%);
      }
      .property-row:last-child { border-bottom: 0; }
      .property-key { color: var(--muted); font-size: 0.75rem; }
      .property-val { font-size: 0.82rem; word-break: break-word; }
      .card {
        border: 1px solid var(--line-2);
        border-radius: 14px;
        padding: 14px;
        background: linear-gradient(170deg, var(--theme-card-a), var(--theme-card-b));
        box-shadow: 0 8px 16px #00000030, inset 0 1px 0 #9ba6bf24;
      }
      h1 { margin: 0 0 10px; }
      .actions {
        display: grid;
        gap: 10px;
        max-width: none;
        width: 100%;
        margin: 0;
      }
      button, .link-btn {
        font: inherit;
        color: inherit;
        border: 1px solid var(--btn-line);
        background: linear-gradient(180deg, var(--theme-btn-a), var(--theme-btn-b));
        border-radius: 8px;
        padding: 10px 12px;
        cursor: pointer;
      }
      button.primary { border-color: var(--btn-active); background: linear-gradient(180deg, color-mix(in srgb, var(--btn-active) 38%, #323846 62%), color-mix(in srgb, var(--btn-line) 58%, #262b36 42%)); }
      .row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
      a.link-btn { text-decoration: none; display: inline-block; }
      .system-status-bar {
        position: fixed;
        left: 0.55rem;
        right: 0.55rem;
        bottom: 0.35rem;
        border: 1px solid var(--line-2);
        border-radius: 10px;
        background: linear-gradient(180deg, #1a1f29f2, #141923f2);
        padding: 0.35rem 0.6rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.7rem;
        z-index: 30;
      }
      .status-pill {
        border: 1px solid var(--line-2);
        border-radius: 999px;
        padding: 0.12rem 0.48rem;
        font-size: 0.72rem;
        font-weight: 700;
      }
      .status-pill.ready { border-color: #1f9e5d; color: #7aefb4; }
      .status-pill.warn { border-color: #b2731b; color: #ffc982; }
      .status-pill.error { border-color: #b73758; color: #ff97b1; }
      .status-text { font-size: 0.76rem; color: var(--muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 56vw; }
      body[data-dept="Video"] {
        --logo-hue: -150deg;
        --line: #3e784f;
        --line-2: #4d8f61;
        --btn-line: #579b67;
        --btn-active: #70c984;
        --theme-bg-a: #0f1612;
        --theme-bg-b: #131f17;
        --theme-bg-c: #101511;
        --theme-glow-a: #4ec06b2f;
        --theme-glow-b: #8ff0a13d;
        --theme-header-a: #213326;
        --theme-header-b: #1b281f;
        --theme-main-a: #1e2a22;
        --theme-main-b: #18231c;
        --theme-card-a: #233226;
        --theme-card-b: #1a261d;
      }
      body[data-dept="Sound"] {
        --logo-hue: -35deg;
        --line: #3e5e97;
        --line-2: #4a6ca9;
        --btn-line: #5479bb;
        --btn-active: #74a9ff;
        --theme-bg-a: #101420;
        --theme-bg-b: #141b2a;
        --theme-bg-c: #0f131e;
        --theme-glow-a: #4e7cd03a;
        --theme-glow-b: #71a2ff33;
        --theme-header-a: #212944;
        --theme-header-b: #1a2137;
        --theme-main-a: #1e2538;
        --theme-main-b: #171e2d;
        --theme-card-a: #252d46;
        --theme-card-b: #1b2235;
      }
      body[data-dept="Lighting"] {
        --logo-hue: 90deg;
        --line: #8a3e44;
        --line-2: #9c474d;
        --btn-line: #b2555d;
        --btn-active: #ff7b85;
        --theme-bg-a: #1b1214;
        --theme-bg-b: #26181b;
        --theme-bg-c: #1a1113;
        --theme-glow-a: #d14e5d30;
        --theme-glow-b: #ff7e7e2e;
        --theme-header-a: #3a2326;
        --theme-header-b: #2b1b1d;
        --theme-main-a: #332225;
        --theme-main-b: #271b1d;
        --theme-card-a: #3a2528;
        --theme-card-b: #2b1d1f;
      }
      body[data-dept="Power"] {
        --logo-hue: 0deg;
        --line: #634699;
        --line-2: #7454ad;
        --btn-line: #7f5ec0;
        --btn-active: #aa84ff;
        --theme-bg-a: #14121f;
        --theme-bg-b: #1d1a2b;
        --theme-bg-c: #12101b;
        --theme-glow-a: #7e5acf34;
        --theme-glow-b: #ab85ff2e;
        --theme-header-a: #2f2744;
        --theme-header-b: #241f34;
        --theme-main-a: #2a243a;
        --theme-main-b: #201c2d;
        --theme-card-a: #322a46;
        --theme-card-b: #262038;
      }
      body[data-dept="Rigging"] {
        --logo-hue: 120deg;
        --line: #a4652c;
        --line-2: #be7736;
        --btn-line: #cf833e;
        --btn-active: #ffab4f;
        --theme-bg-a: #1c1510;
        --theme-bg-b: #261c13;
        --theme-bg-c: #1a130d;
        --theme-glow-a: #d67a2e2f;
        --theme-glow-b: #ffb35a2a;
        --theme-header-a: #3b2517;
        --theme-header-b: #2c1b11;
        --theme-main-a: #342518;
        --theme-main-b: #261c13;
        --theme-card-a: #3f2a19;
        --theme-card-b: #2f2013;
      }
      body[data-dept="Venue"] {
        --logo-hue: -100deg;
        --line: #3f8a86;
        --line-2: #49a29d;
        --btn-line: #54b5b0;
        --btn-active: #6ad8d1;
        --theme-bg-a: #101a19;
        --theme-bg-b: #132423;
        --theme-bg-c: #0f1716;
        --theme-glow-a: #45b6ac2e;
        --theme-glow-b: #7de9df2a;
        --theme-header-a: #1f3230;
        --theme-header-b: #182826;
        --theme-main-a: #1d2d2b;
        --theme-main-b: #172422;
        --theme-card-a: #223634;
        --theme-card-b: #1b2a28;
      }
      /* Keep UI neutral grey; preserve department accents for highlights */
      body[data-dept] {
        --theme-bg-a: #101116;
        --theme-bg-b: #171922;
        --theme-bg-c: #111217;
        --theme-glow-a: #6a738420;
        --theme-glow-b: #8d97aa1a;
        --theme-header-a: #2b3039;
        --theme-header-b: #232831;
        --theme-main-a: #252932;
        --theme-main-b: #20242c;
        --theme-card-a: #303640;
        --theme-card-b: #282e38;
        --theme-input: #1b1923;
        --theme-btn-a: #343946;
        --theme-btn-b: #2a2f3a;
      }
      @media (max-width: 1100px) {
        .layout { grid-template-columns: 1fr; }
        .properties-panel { display: none; }
      }
      @media (max-width: 820px) {
        .layout { grid-template-columns: 1fr; }
      }
    </style>
  </head>
  <body>
    <div class="shell">
      <header class="header">
        <div class="brand">
          <img id="brandLogo" class="brand-logo" src="assets/base-logo.png" alt="BASE Logo" />
          <div class="brand-dot" id="brandFallback" style="display:none;">B</div>
          <div>
            <div class="brand-wordmark">THE BASE</div>
            <p>Technical planning dashboard for Video, Lighting, Audio, Staging & Rigging.</p>
          </div>
        </div>
        <div class="header-links">
          <a class="header-link-btn active" href="projects.html">Projects</a>
          <a class="header-link-btn" href="index.html">Engineering</a>
          <a class="header-link-btn" href="reports.html">Reports</a>
          <a class="header-link-btn" href="settings.html">Settings</a>
        </div>
        <div class="header-actions"></div>
      </header>
      <section class="layout">
        <main class="main">
        <div class="card" style="margin-bottom:0.7rem;">
          <div class="row">
            <h1 style="margin:0;">Projects</h1>
            <div style="display:flex;gap:0.45rem;align-items:center;flex-wrap:wrap;">
              <span id="projectUserLabel" class="muted">Not signed in</span>
              <a class="link-btn" id="projectLoginBtn" href="login.html">Login</a>
              <button id="projectLogoutBtn" style="display:none;">Logout</button>
            </div>
          </div>
          <div id="projectCloudStatus" class="muted">Checking cloud connection...</div>
        </div>

        <div id="projectWorkspace" style="display:none;">
          <div class="card" style="margin-bottom:0.7rem;">
            <div class="row"><h2 style="margin:0;">New Project</h2></div>
            <div style="display:grid;grid-template-columns:2fr 3fr auto;gap:0.45rem;align-items:end;">
              <div>
                <label style="display:block;font-size:0.8rem;color:var(--muted);margin-bottom:0.2rem;">Project Name</label>
                <input id="projectNameInput" type="text" placeholder="e.g. Arena Tour - Cape Town" style="width:100%;background:#181b25;border:1px solid var(--line-2);color:var(--text);border-radius:8px;padding:0.42rem;" />
              </div>
              <div>
                <label style="display:block;font-size:0.8rem;color:var(--muted);margin-bottom:0.2rem;">Description</label>
                <input id="projectDescInput" type="text" placeholder="Optional project notes" style="width:100%;background:#181b25;border:1px solid var(--line-2);color:var(--text);border-radius:8px;padding:0.42rem;" />
              </div>
              <button class="primary" id="projectCreateBtn">New Project</button>
            </div>
            <div id="projectCreateStatus" class="muted" style="margin-top:0.45rem;"></div>
          </div>

          <div class="card" style="margin-bottom:0.7rem;">
            <div class="row"><h2 style="margin:0;">Open Project</h2></div>
            <div id="projectListWrap" class="muted">No projects yet.</div>
          </div>

          <div class="card" id="projectTeamCard" style="display:none;">
            <div class="row"><h2 style="margin:0;">Team Members</h2><span id="projectTeamRole" class="muted"></span></div>
            <div id="projectTeamAddRow" style="display:grid;grid-template-columns:2fr auto auto;gap:0.45rem;align-items:end;margin-bottom:0.5rem;">
              <div>
                <label style="display:block;font-size:0.8rem;color:var(--muted);margin-bottom:0.2rem;">Invite By Email</label>
                <input id="projectMemberEmail" type="email" placeholder="teammate@email.com" style="width:100%;background:#181b25;border:1px solid var(--line-2);color:var(--text);border-radius:8px;padding:0.42rem;" />
              </div>
              <select id="projectMemberRole" style="background:#181b25;border:1px solid var(--line-2);color:var(--text);border-radius:8px;padding:0.42rem;">
                <option value="member">Member</option>
                <option value="owner">Owner</option>
              </select>
              <button id="projectAddMemberBtn">Add Team Member</button>
            </div>
            <div id="projectTeamStatus" class="muted" style="margin-bottom:0.4rem;"></div>
            <div id="projectTeamList" class="muted">Select a project.</div>
          </div>
          </div>
        </main>
      </section>
    </div>
    <footer class="system-status-bar" id="projectsStatusBar">
      <div style="display:flex;align-items:center;gap:0.65rem;min-width:0;">
        <span class="status-pill ready" id="projectsStatusPill">READY</span>
        <span class="status-text" id="projectsStatusText">Project center ready</span>
      </div>
      <div style="display:flex;align-items:center;gap:0.65rem;">
        <span class="link-btn" style="padding:0.12rem 0.46rem;">Engineering Data Mode</span>
        <span class="muted" style="font-size:0.76rem;">Projects</span>
      </div>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="data/auth-config.js"></script>
    <script src="data/auth-projects.js"></script>
    <script>
      const logo = document.getElementById("brandLogo");
      const fallback = document.getElementById("brandFallback");
      if (logo && fallback) {
        logo.addEventListener("error", () => {
          logo.style.display = "none";
          fallback.style.display = "grid";
        });
      }
      document.body.setAttribute("data-dept", "Power");
      (function () {
        const cloudStatus = document.getElementById("projectCloudStatus");
        const workspace = document.getElementById("projectWorkspace");
        const loginBtn = document.getElementById("projectLoginBtn");
        const logoutBtn = document.getElementById("projectLogoutBtn");
        const userLabel = document.getElementById("projectUserLabel");
        const createStatus = document.getElementById("projectCreateStatus");
        const projectListWrap = document.getElementById("projectListWrap");
        const teamCard = document.getElementById("projectTeamCard");
        const teamList = document.getElementById("projectTeamList");
        const teamStatus = document.getElementById("projectTeamStatus");
        const teamRoleLabel = document.getElementById("projectTeamRole");
        const teamAddRow = document.getElementById("projectTeamAddRow");

        let currentUser = null;
        let selectedProject = null;
        let selectedRole = "";
        const projectsSidebar = document.getElementById("projectsSidebar");
        const projectsPropertyTabs = document.getElementById("projectsPropertyTabs");
        const projectsPropertyBody = document.getElementById("projectsPropertyBody");
        const projectsPropObject = document.getElementById("projectsPropObject");
        const projectsStatusPill = document.getElementById("projectsStatusPill");
        const projectsStatusText = document.getElementById("projectsStatusText");
        const PROJECT_PROP_TABS = ["General", "Signal / Routing", "Power", "Network", "Physical", "Notes"];
        let projectPropertyTab = "General";
        const MODULE_MENU = [
          { href: "projects.html", label: "Projects", iconKey: "projects", color: "#8b5cff", active: true },
          { href: "index.html?dept=Video", label: "Video", iconKey: "video", color: "#57b36a" },
          { href: "index.html?dept=Lighting", label: "Lighting", iconKey: "lighting", color: "#e25555" },
          { href: "index.html?dept=Sound", label: "Audio", iconKey: "audio", color: "#4f82ff" },
          { href: "index.html?dept=Rigging", label: "Rigging", iconKey: "rigging", color: "#f08a3c" },
          { href: "index.html?dept=Power", label: "Power", iconKey: "power", color: "#8b5cff" },
          { href: "index.html?dept=Venue", label: "3D", iconKey: "venue3d", color: "#35bdb0" },
          { href: "reports.html", label: "Reports", iconKey: "outputs", color: "#7c889f" },
          { href: "settings.html", label: "Settings", iconKey: "settings", color: "#8b5cff" }
        ];

        const esc = (v) => String(v == null ? "" : v).replace(/[&<>"']/g, (c) => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#39;" }[c]));
        const setMsg = (el, msg, ok) => {
          if (!el) return;
          el.textContent = String(msg || "");
          el.style.color = ok ? "#c4ffe2" : "#ffb6c6";
        };
        const setMuted = (el, msg) => {
          if (!el) return;
          el.textContent = String(msg || "");
          el.style.color = "#b8b3c9";
        };
        function renderProjectsSidebar() {
          if (!projectsSidebar) return;
          const iconSvg = (key) => {
            const icons = {
              video: '<svg viewBox="0 0 24 24" fill="none" stroke-width="2.3" stroke-linecap="round" stroke-linejoin="round"><rect x="3.5" y="5.5" width="14" height="10" rx="2"></rect><path d="M17.5 8.5L21 6.8v7.4l-3.5-1.7z"></path><path d="M6 18.5h9"></path><path d="M10.5 15.5v3"></path></svg>',
              lighting: '<svg viewBox="0 0 24 24" fill="none" stroke-width="2.3" stroke-linecap="round" stroke-linejoin="round"><path d="M7 4.5h10"></path><path d="M8.5 4.5v4l3.5 4v3"></path><path d="M15.5 4.5v4l-3.5 4"></path><path d="M9.5 18h5"></path><path d="M10.5 20h3"></path></svg>',
              audio: '<svg viewBox="0 0 24 24" fill="none" stroke-width="2.3" stroke-linecap="round" stroke-linejoin="round"><path d="M3.5 14h3l4.5 3.5V6.5L6.5 10h-3z"></path><path d="M14.5 10.2a4.2 4.2 0 0 1 0 3.6"></path><path d="M17.5 8a7.4 7.4 0 0 1 0 8"></path><path d="M20 5.5a11 11 0 0 1 0 13"></path></svg>',
              rigging: '<svg viewBox="0 0 24 24" fill="none" stroke-width="2.3" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6.5h16"></path><path d="M6.5 6.5l5.5 10 5.5-10"></path><path d="M9.2 11.4h5.6"></path><path d="M12 16.5v4"></path><circle cx="12" cy="21" r="1.4"></circle></svg>',
              power: '<svg viewBox="0 0 24 24" fill="none" stroke-width="2.3" stroke-linecap="round" stroke-linejoin="round"><path d="M8.5 4v6"></path><path d="M15.5 4v6"></path><path d="M6 10h12v4a6 6 0 0 1-12 0z"></path></svg>',
              venue3d: '<svg viewBox="0 0 24 24" fill="none" stroke-width="2.3" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3l8 4.5v9L12 21l-8-4.5v-9z"></path><path d="M12 12l8-4.5"></path><path d="M12 12v9"></path><path d="M12 12L4 7.5"></path></svg>',
              outputs: '<svg viewBox="0 0 24 24" fill="none" stroke-width="2.3" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="3.5" width="13" height="17" rx="2"></rect><path d="M8 8h5"></path><path d="M8 12h5"></path><path d="M8 16h3"></path><path d="M17 8.5h3.5"></path><path d="M18.8 6.8l1.7 1.7-1.7 1.7"></path></svg>',
              projects: '<svg viewBox="0 0 24 24" fill="none" stroke-width="2.3" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="5" width="8" height="6" rx="1.5"></rect><rect x="13" y="5" width="8" height="6" rx="1.5"></rect><rect x="8" y="13" width="8" height="6" rx="1.5"></rect><path d="M11 8h2"></path><path d="M12 11v2"></path></svg>',
              settings: '<svg viewBox="0 0 24 24" fill="none" stroke-width="2.3" stroke-linecap="round" stroke-linejoin="round"><circle cx="8" cy="7" r="2"></circle><circle cx="16" cy="12" r="2"></circle><circle cx="10" cy="17" r="2"></circle><path d="M10 7h10"></path><path d="M3.5 7H6"></path><path d="M3.5 12H14"></path><path d="M18 12h2.5"></path><path d="M3.5 17H8"></path><path d="M12 17h8.5"></path></svg>'
            };
            return icons[key] || icons.settings;
          };
          projectsSidebar.innerHTML = MODULE_MENU.map((m) => `
            <a href="${m.href}" style="text-decoration:none;">
              <button class="${m.active ? "active" : ""}" title="${m.label}">
                <span class="nav-icon" style="border-color:${m.color};color:${m.color};">${iconSvg(m.iconKey)}</span>
                <span class="nav-label">${m.label}</span>
              </button>
            </a>
          `).join("");
        }
        function getProjectPropertyRows() {
          const tab = String(projectPropertyTab || "General");
          if (tab === "General") return [
            { k: "Selected", v: selectedProject?.name || "No project selected" },
            { k: "Role", v: selectedRole || "-" },
            { k: "User", v: currentUser?.email || "Not signed in" }
          ];
          if (tab === "Network") return [
            { k: "Cloud Auth", v: window.TheBaseCloud?.isConfigured?.() ? "Configured" : "Local mode" },
            { k: "Sync", v: "Project snapshots stored per project" }
          ];
          if (tab === "Notes") return [
            { k: "Access", v: "Only assigned team members can access a project." },
            { k: "Flow", v: "New / Open / Export / Team management." }
          ];
          return [{ k: "Category", v: tab }];
        }
        function renderProjectsProperties() {
          if (!projectsPropertyTabs || !projectsPropertyBody || !projectsPropObject) return;
          projectsPropObject.textContent = selectedProject?.name ? "project" : "none";
          projectsPropertyTabs.innerHTML = PROJECT_PROP_TABS.map((tab) => `<button data-proj-prop-tab="${tab}" class="${tab === projectPropertyTab ? "active" : ""}">${tab}</button>`).join("");
          projectsPropertyBody.innerHTML = getProjectPropertyRows().map((r) => `
            <div class="property-row">
              <div class="property-key">${r.k}</div>
              <div class="property-val">${r.v}</div>
            </div>
          `).join("");
          projectsPropertyTabs.querySelectorAll("[data-proj-prop-tab]").forEach((btn) => {
            btn.addEventListener("click", () => {
              projectPropertyTab = btn.getAttribute("data-proj-prop-tab") || "General";
              renderProjectsProperties();
            });
          });
        }
        function renderProjectsStatus(level, text) {
          if (!projectsStatusPill || !projectsStatusText) return;
          const safeLevel = level || "READY";
          projectsStatusPill.textContent = safeLevel;
          projectsStatusPill.className = `status-pill ${safeLevel === "ERROR" ? "error" : (safeLevel === "WARN" ? "warn" : "ready")}`;
          projectsStatusText.textContent = text || "Project center ready";
        }

        async function renderProjectList() {
          if (!window.TheBaseCloud) return;
          let list = [];
          try {
            list = await TheBaseCloud.listProjects();
          } catch (err) {
            setMsg(projectListWrap, err?.message || "Failed to load projects", false);
            return;
          }
          if (!list.length) {
            projectListWrap.innerHTML = '<div class="muted">No projects yet. Create your first project above.</div>';
            teamCard.style.display = "none";
            renderProjectsProperties();
            renderProjectsStatus("WARN", "No projects found. Create your first project.");
            return;
          }
          const active = TheBaseCloud.getActiveProject();
          projectListWrap.innerHTML = `
            <div style="overflow:auto;">
              <table style="width:100%;border-collapse:collapse;font-size:0.86rem;">
                <thead>
                  <tr>
                    <th style="text-align:left;border:1px solid var(--line);padding:0.35rem;">Name</th>
                    <th style="text-align:left;border:1px solid var(--line);padding:0.35rem;">Role</th>
                    <th style="text-align:left;border:1px solid var(--line);padding:0.35rem;">Updated</th>
                    <th style="text-align:left;border:1px solid var(--line);padding:0.35rem;">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  ${list.map((p) => `
                    <tr>
                      <td style="border:1px solid var(--line);padding:0.35rem;"><strong>${esc(p.name)}</strong><div class="muted" style="font-size:0.78rem;">${esc(p.description || "")}</div></td>
                      <td style="border:1px solid var(--line);padding:0.35rem;">${esc(p.role || "member")}</td>
                      <td style="border:1px solid var(--line);padding:0.35rem;">${new Date(p.updated_at || p.created_at || Date.now()).toLocaleString()}</td>
                      <td style="border:1px solid var(--line);padding:0.35rem;">
                        <div style="display:flex;gap:0.35rem;flex-wrap:wrap;">
                          <button data-open-project="${esc(p.id)}" class="${active?.id === p.id ? "primary" : ""}">Open Project</button>
                          <button data-export-project="${esc(p.id)}">Export Project</button>
                          <button data-team-project="${esc(p.id)}">Team</button>
                          ${String(p.role || "") === "owner" ? `<button data-delete-project="${esc(p.id)}">Delete</button>` : ""}
                        </div>
                      </td>
                    </tr>
                  `).join("")}
                </tbody>
              </table>
            </div>
          `;

          projectListWrap.querySelectorAll("[data-open-project]").forEach((btn) => {
            btn.addEventListener("click", () => {
              const id = btn.getAttribute("data-open-project") || "";
              const project = list.find((p) => p.id === id);
              if (!project) return;
              TheBaseCloud.setActiveProject({ id: project.id, name: project.name });
              window.location.href = "index.html";
            });
          });

          projectListWrap.querySelectorAll("[data-export-project]").forEach((btn) => {
            btn.addEventListener("click", async () => {
              const id = btn.getAttribute("data-export-project") || "";
              try {
                const project = list.find((p) => p.id === id);
                const snapshot = await TheBaseCloud.loadProjectSnapshot(id);
                const payload = {
                  project: project || null,
                  snapshot: snapshot?.snapshot || null,
                  exported_at: new Date().toISOString()
                };
                const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `${(project?.name || "project").replace(/\\s+/g, "_")}.json`;
                a.click();
                URL.revokeObjectURL(url);
              } catch (err) {
                alert(err?.message || "Export failed");
              }
            });
          });

          projectListWrap.querySelectorAll("[data-team-project]").forEach((btn) => {
            btn.addEventListener("click", async () => {
              const id = btn.getAttribute("data-team-project") || "";
              const project = list.find((p) => p.id === id);
              if (!project) return;
              selectedProject = project;
              selectedRole = project.role || "member";
              await renderTeam();
              renderProjectsProperties();
            });
          });
          projectListWrap.querySelectorAll("[data-delete-project]").forEach((btn) => {
            btn.addEventListener("click", async () => {
              const id = btn.getAttribute("data-delete-project") || "";
              const project = list.find((p) => p.id === id);
              if (!project) return;
              const ok = window.confirm(`Delete project \"${project.name}\"? This cannot be undone.`);
              if (!ok) return;
              try {
                await TheBaseCloud.deleteProject(project.id);
                if (selectedProject?.id === project.id) {
                  selectedProject = null;
                  selectedRole = "";
                  teamCard.style.display = "none";
                }
                await renderProjectList();
              } catch (err) {
                alert(err?.message || "Failed to delete project");
              }
            });
          });
          renderProjectsProperties();
          renderProjectsStatus("READY", `Loaded ${list.length} project(s).`);
        }

        async function renderTeam() {
          if (!selectedProject) {
            teamCard.style.display = "none";
            renderProjectsProperties();
            return;
          }
          teamCard.style.display = "block";
          teamRoleLabel.textContent = `${selectedProject.name} (${selectedRole})`;
          teamAddRow.style.display = selectedRole === "owner" ? "grid" : "none";
          setMuted(teamStatus, selectedRole === "owner" ? "Owner controls enabled." : "Read-only. Only owners can manage team.");
          try {
            const members = await TheBaseCloud.listProjectMembers(selectedProject.id);
            teamList.innerHTML = `
              <div style="overflow:auto;">
                <table style="width:100%;border-collapse:collapse;font-size:0.86rem;">
                  <thead><tr><th style="text-align:left;border:1px solid var(--line);padding:0.35rem;">Name</th><th style="text-align:left;border:1px solid var(--line);padding:0.35rem;">Email</th><th style="text-align:left;border:1px solid var(--line);padding:0.35rem;">Department</th><th style="text-align:left;border:1px solid var(--line);padding:0.35rem;">Role</th><th style="text-align:left;border:1px solid var(--line);padding:0.35rem;">Action</th></tr></thead>
                  <tbody>
                    ${members.map((m) => `
                      <tr>
                        <td style="border:1px solid var(--line);padding:0.35rem;">${esc(m.name || "User")}</td>
                        <td style="border:1px solid var(--line);padding:0.35rem;">${esc(m.email || "")}</td>
                        <td style="border:1px solid var(--line);padding:0.35rem;">${esc(m.department || "")}</td>
                        <td style="border:1px solid var(--line);padding:0.35rem;">${esc(m.role || "member")}</td>
                        <td style="border:1px solid var(--line);padding:0.35rem;">
                          ${selectedRole === "owner" && m.user_id !== currentUser?.id ? `<button data-remove-member="${esc(m.user_id)}">Remove</button>` : '<span class="muted">-</span>'}
                        </td>
                      </tr>
                    `).join("")}
                  </tbody>
                </table>
              </div>
            `;
            if (selectedRole === "owner") {
              teamList.querySelectorAll("[data-remove-member]").forEach((btn) => {
                btn.addEventListener("click", async () => {
                  const userId = btn.getAttribute("data-remove-member");
                  if (!userId) return;
                  try {
                    await TheBaseCloud.removeMember(selectedProject.id, userId);
                    await renderTeam();
                  } catch (err) {
                    setMsg(teamStatus, err?.message || "Failed to remove member", false);
                  }
                });
              });
            }
            renderProjectsProperties();
          } catch (err) {
            setMsg(teamStatus, err?.message || "Failed to load team", false);
            renderProjectsStatus("WARN", err?.message || "Failed to load team");
          }
        }

        document.getElementById("projectCreateBtn")?.addEventListener("click", async () => {
          const name = document.getElementById("projectNameInput")?.value || "";
          const description = document.getElementById("projectDescInput")?.value || "";
          if (!name.trim()) {
            setMsg(createStatus, "Project name is required", false);
            return;
          }
          try {
            const project = await TheBaseCloud.createProject(name, description);
            setMsg(createStatus, "Project created.", true);
            TheBaseCloud.setActiveProject({ id: project.id, name: project.name });
            document.getElementById("projectNameInput").value = "";
            document.getElementById("projectDescInput").value = "";
            await renderProjectList();
          } catch (err) {
            setMsg(createStatus, err?.message || "Create project failed", false);
          }
        });

        document.getElementById("projectAddMemberBtn")?.addEventListener("click", async () => {
          if (!selectedProject || selectedRole !== "owner") return;
          const email = document.getElementById("projectMemberEmail")?.value || "";
          const role = document.getElementById("projectMemberRole")?.value || "member";
          try {
            await TheBaseCloud.addMemberByEmail(selectedProject.id, email, role);
            setMsg(teamStatus, "Team member added.", true);
            document.getElementById("projectMemberEmail").value = "";
            await renderTeam();
          } catch (err) {
            setMsg(teamStatus, err?.message || "Failed to add member", false);
          }
        });

        logoutBtn?.addEventListener("click", async () => {
          try {
            await TheBaseCloud.signOut();
          } finally {
            window.location.href = "login.html?next=projects.html";
          }
        });

        async function bootstrap() {
          renderProjectsSidebar();
          renderProjectsProperties();
          renderProjectsStatus("READY", "Initializing project center");
          if (!window.TheBaseCloud || !TheBaseCloud.isConfigured()) return;
          try {
            await TheBaseCloud.init();
            currentUser = await TheBaseCloud.getUser();
            if (!currentUser) {
              const modeText = TheBaseCloud.isCloudMode && TheBaseCloud.isCloudMode()
                ? "Cloud mode: not signed in. Login to access project database."
                : "Local mode: not signed in. Create/login account to access projects.";
              setMuted(cloudStatus, modeText);
              loginBtn.style.display = "inline-block";
              logoutBtn.style.display = "none";
              workspace.style.display = "none";
              renderProjectsStatus("WARN", "Not signed in");
              return;
            }
            await TheBaseCloud.ensureProfile(currentUser);
            userLabel.textContent = `${currentUser.user_metadata?.name || currentUser.email || "User"}`;
            loginBtn.style.display = "none";
            logoutBtn.style.display = "inline-block";
            workspace.style.display = "block";
            setMuted(
              cloudStatus,
              (TheBaseCloud.isCloudMode && TheBaseCloud.isCloudMode())
                ? "Cloud connected. Projects are private to assigned team members."
                : "Local mode active. Projects are private per local account and project membership."
            );
            renderProjectsStatus("READY", "Connected and ready");
            await renderProjectList();
          } catch (err) {
            setMsg(cloudStatus, err?.message || "Failed to initialize cloud", false);
            workspace.style.display = "none";
            renderProjectsStatus("ERROR", err?.message || "Cloud initialization failed");
          }
        }

        bootstrap();
      })();
    </script>
  </body>
</html>
